#include <stdint.h>
#include <stdlib.h>
#include <string.h>

#include <cpuid.h>
#include <macros.h>

struct vendor {
	const char *key;
	enum cpuid_vendor_id value;
} vendors[] = {
	{ "GenuineIntel", CPUID_VENDOR_INTEL },
};

const char *models[] = {
	[0x1a] = "Nehalem",
	[0x1d] = "Dunnington",
	[0x1e] = "Nehalem",
	[0x1f] = "Nehalem",
	[0x25] = "Westmere",
	[0x2a] = "Sandy Bridge",
	[0x2c] = "Westmere",
	[0x2d] = "Sandy Bridge",
	[0x2e] = "Nehalem",
	[0x2f] = "Westmere",
	[0x37] = "Baytrail",
	[0x3a] = "Ivy Bridge",
	[0x3c] = "Haswell",
	[0x3d] = "Broadwell",
	[0x3e] = "Ivy Bridge",
	[0x3f] = "Haswell",
	[0x45] = "Haswell",
	[0x46] = "Haswell",
	[0x47] = "Broadwell",
	[0x4d] = "Avoton",
	[0x4e] = "Skylake",
	[0x4f] = "Broadwell",
	[0x55] = "Skylake",
	[0x56] = "Broadwell",
	[0x5c] = "Apollo Lake",
	[0x5e] = "Skylake",
	[0x5f] = "Denverton",
	[0x8e] = "Kaby Lake",
	[0x9e] = "Kaby Lake",
};

const char *intel_get_cpu_model(void)
{
	unsigned model;
	uint32_t reg;

	asm volatile(
		"cpuid" :
		"=a" (reg) :
		"a" (0x00000001) :
		"%ebx", "%ecx", "%edx");

	model = (EXTRACT(reg, 16, 4) << 4) | EXTRACT(reg, 4, 4);

	return models[model];
}


unsigned cpuid_get_max_leaf(void)
{
	static unsigned max_leaf;

	if (max_leaf)
		return max_leaf;
	
	asm volatile(
		"cpuid" :
		"=a" (max_leaf) :
		"a" (0) :
		"%ebx", "%ecx", "%edx");

	return max_leaf;
}

unsigned cpuid_get_max_ext_leaf(void)
{
	static unsigned max_leaf;

	if (max_leaf)
		return max_leaf;

	asm volatile(
		"cpuid" :
		"=a" (max_leaf) :
		"a" (0x80000000) :
		"%ebx", "%ecx", "%edx");

	return max_leaf;
}

enum cpuid_vendor_id cpuid_get_vendor_id(void)
{
	static enum cpuid_vendor_id vendor_id = CPUID_VENDOR_NONE;
	const char *vendor;
	size_t i;

	if (vendor_id != CPUID_VENDOR_NONE)
		return vendor_id;

	vendor = cpuid_get_vendor();

	for (i = 0; i < sizeof(vendors) / sizeof(*vendors); ++i) {
		if (strcmp(vendor, vendors[i].key) == 0) {
			vendor_id = vendors[i].value;

			return vendor_id;
		}
	}

	return vendor_id;
}

const char *cpuid_get_vendor(void)
{
	uint32_t regs[3];
	static char buffer[13];
	static char *vendor;

	if (vendor)
		return vendor;

	asm volatile(
		"cpuid" :
		"=b" (regs[0]), "=c" (regs[2]), "=d" (regs[1]) :
		"a" (0));

	vendor = buffer;
	memcpy(vendor, regs, 12);

	return vendor;
}

const char *cpuid_get_cpu_name(void)
{
	static char buf[3 * 4 * sizeof(uint32_t) + 1];
	char *name = NULL, *p;
	uint32_t func;

	if (name)
		return name;

	if (cpuid_get_max_ext_leaf() < 0x80000004)
		return 0;

	for (p = buf, func = 0x80000002; func <= 0x80000004; p += 16, ++func) {
		asm volatile("cpuid\n" :
			"=a" (*(uint32_t *)p),
			"=b" (*(uint32_t *)(p + 4)),
			"=c" (*(uint32_t *)(p + 8)),
			"=d" (*(uint32_t *)(p + 12)) :
			"a" (func));
	}

	name = buf + strspn(buf, " ");

	return name;
}

const char *cpuid_get_cpu_model(void)
{
	switch (cpuid_get_vendor_id()) {
	case CPUID_VENDOR_INTEL: return intel_get_cpu_model();
	default: return NULL;
	}
}
