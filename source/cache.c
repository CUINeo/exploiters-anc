

#include <stdint.h>
#include <stdlib.h>
#include <string.h>
#include <sys/mman.h>
#include "cache.h"
#include "paging.h"

#define min(x, y) (((x) < (y)) ? (x) : (y))
#define max(x, y) (((x) > (y)) ? (x) : (y))

//create cache 
struct cache *new_cache(struct page_format *fmt, void *target, size_t cache_size, size_t line_size)
{
	size_t i=0;
	size_t ide = 0;
	
	struct page_level *level;
	struct cache *cache;
	
	unsigned flags = MAP_ANONYMOUS | MAP_PRIVATE | MAP_NORESERVE;

	if (target)
		flags |= MAP_FIXED;

	if (!(cache = malloc(sizeof *cache)))
		return NULL;

	cache->fmt = fmt;
	cache->cache_size = cache_size;
	cache->line_size = line_size;
	cache->size = cache_size;
	level = fmt->levels;
	while (i < fmt->nlevels)
	{
		ide = max(level->page_size, level->table_size);
		cache->size = max(cache->size, level->ncache_entries * ide);
		++i;
		++level;
	}

	if ((cache->data = mmap(target, cache->size, PROT_READ | PROT_WRITE, flags,
		-1, 0)) == MAP_FAILED) {

		memset(cache, 0, sizeof *cache);
	    return NULL;
	}
	return cache;
}
//clear the cache 
void del_cache(struct cache *cache)
{
	munmap(cache->data, cache->size);
	memset(cache, 0, sizeof *cache);
}
