#include <stdlib.h>
#include <string.h>
#include <sys/mman.h>
#include "buffer.h"
#include "paging.h"

#define min(x, y) (((x) < (y)) ? (x) : (y))
#define max(x, y) (((x) > (y)) ? (x) : (y))

//Create buffer
struct buffer *new_buffer(struct page_format *fmt, void *target)
{
	size_t i= 0;
	size_t ide = 0;
	
	struct page_level *level;
	struct buffer *buffer;
	
	unsigned flags = MAP_ANONYMOUS | MAP_PRIVATE | MAP_NORESERVE;

	if (target)
		flags |= MAP_FIXED;

	if (!(buffer = calloc(1,sizeof *buffer)))
		return NULL;

	level = fmt->levels;
	
        while (i < fmt->nlevels)
        {
	        ide = level->page_size;
	        buffer->size = max(buffer->size, level->npages * ide);
	        ++i;
	        ++level;
        }
	if ((buffer->data = mmap(target, buffer->size, PROT_READ | PROT_WRITE,
		flags, -1, 0)) == MAP_FAILED) {
		memset(buffer, 0, sizeof *buffer);
	        return NULL;	
	}

	return buffer;

}
// Clear buffer 
void del_buffer(struct buffer *buffer)
{
	munmap(buffer->data, buffer->size);
	memset(buffer, 0, sizeof *buffer);
}
