#include <stdint.h>
#include <stdlib.h>
#include "solver.h"

#define min(x, y) (((x) < (y)) ? (x) : (y))
#define max(x, y) (((x) > (y)) ? (x) : (y))

void normalise_timings(double *ntimings, uint64_t *timings,
	size_t ncache_lines, size_t npages)
{
	size_t x=0, y=0;
	uint64_t timing, lo, hi;
	double ntiming;

while (y < npages)
	{
		lo = UINT64_MAX;
		hi = 0;

		while ( x < ncache_lines ) {
			timing = timings[y * ncache_lines + x];

			lo = min(lo, timing);
			hi = max(hi, timing);
			++x;
		}
        x = 0;
		while ( x < ncache_lines) {
			timing = timings[y * ncache_lines + x] - lo;

			if (hi == lo) {
				ntiming = 1.0;
			} else {
				ntiming = timing / (hi - lo);
			}

			ntimings[y * ncache_lines + x] = ntiming;
			++x;
		}
		++y;
	}
}

void solve_lines(size_t *best_line, size_t *best_page,
	double *timings, size_t ncache_lines, size_t npages,
	size_t npages_per_line)
{
	size_t line=0, page;
	double line_sum;
	double best_sum = 0;

	while (line < ncache_lines) {
		for (page = 0; page < npages_per_line; ++page) {
	line_sum = solve_line(timings, line, page, ncache_lines, npages, npages_per_line);

			if (line_sum > best_sum) {
				best_sum = line_sum;
				*best_line = line;
				*best_page = page;
			}
		}
		++line;
	}
}

double solve_line(double *timings, size_t line, size_t page,
	size_t ncache_lines, size_t npages, size_t npages_per_line)
{

	double sum = 0;
	size_t row=0, col;
	while ( row < npages) {
		col = (line + (row + page) / npages_per_line) % ncache_lines;
		sum += timings[col + row * ncache_lines];
		++row;
	}

	return sum;
}

